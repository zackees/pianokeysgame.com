<!DOCTYPE HTML>
<html xml:lang="en" lang="en">

<head></head>

<style>
    * {
        font-family: Helvetica, sans-serif;
    }

    input[type="button"] {
        font-size: 24px;
    }

    input[type=text] {
        width: 400px;
        font-size: 18pt;
        margin-bottom: 5px;
    }

    #div_container {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #div_main {
        width: var(--canvas-width)px;
    }

    #div_stimulus {
        min-height: 4em;
    }

    .wide {
        padding: 30px;
        margin: 10px;
    }
</style>

<body>
    <div id="div_container">
        <div id="div_main">
            <H1>Piano Keys Game!</H1>
            <h2>Sound Game</h2>
            <p>Listen to the tone then select the key.</p>
            <input type="button" value="play tone" id="btn_play_tone"></input>
            <p id="right_answer" style="color: Red;"></p>
            <p id="correct" style="color: Green;"></p>
            <br>
            <div id="div_white_keys">
                <h3>White Keys</h3>
                <input type="button" id="A" value="A" class="wide"></input>
                <input type="button" id="B" value="B" class="wide"></input>
                <input type="button" id="C" value="C" class="wide"></input>
                <input type="button" id="D" value="D" class="wide"></input>
                <br>
                <input type="button" id="E" value="E" class="wide"></input>
                <input type="button" id="F" value="F" class="wide"></input>
                <input type="button" id="G" value="G" class="wide"></input>
            </div>
        </div>
    </div>

    <script src="sound.js"></script>
    <script>
        const notes = [
            "C", "D", "E", "F", "G", "A", "B",
        ];

        function shuffle_array(array) {
            let out = array.slice(0, array.length); // copy.
            for (let i = 0; i < out.length; ++i) {
                let j = Math.floor(Math.random() * out.length);
                let tmp = out[i];
                out[i] = out[j];
                out[j] = tmp;
            }
            return out;
        }
        class Controller {
            constructor(notes) {
                this.notes = notes;
                this.note_order = shuffle_array(notes);
                this.note_working_set = {}
                this.max_active_test_sets = 3;
                this.curr_random_note = null;
                this.right_answer = document.getElementById("right_answer");
                while (this.has_more_notes()) {
                    this.note_working_set[this.note_order.pop()] = 0;
                }
            }

            play_current_note() {
                play_note(this.curr_random_note);
            }

            has_more_notes() {
                const n = Object.keys(this.note_working_set).length;
                return n < this.max_active_test_sets && this.note_order.length > 0;
            }

            static random_int(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }


            reveal_answer() {
                const num_wrong = -(this.note_working_set[this.curr_random_note] - 1);
                right_answer.innerText = `Wrong, it was "${this.curr_random_note}", which needs ${num_wrong} right answers before it's finished.`;
            }

            random_next() {
                console.log(this.notes);
                const i = Controller.random_int(0, this.notes.length);
                const note_working_set_array = Object.keys(this.note_working_set);
                if (note_working_set_array.length == 0) {
                    return false;  // No more items.
                }
                let note = null;
                while (true) {
                    const i = Controller.random_int(0, note_working_set_array.length);
                    note = note_working_set_array[i];
                    if (note_working_set_array.length == 1 || note != this.curr_random_note) {
                        break;
                    }
                }
                this.curr_random_note = note;
                right_answer.innerText = "";
                //const ctx = context();
                return true;  // More in the set.
            }

            submit(value) {
                if (value != this.curr_random_note) {
                    console.log(`${value} != ${this.curr_random_note}`);
                    // Two, because the next answer will be right.
                    this.note_working_set[this.curr_random_note] -= 2;
                    document.getElementById("correct").innerText = "";
                    this.reveal_answer();
                } else {
                    console.log(`${value} == ${this.curr_random_note}`);
                    play_note(value);
                    this.note_working_set[this.curr_random_note] += 1;
                    if (this.note_working_set[this.curr_random_note] > 0) {
                        delete this.note_working_set[this.curr_random_note];
                        if (has_more_notes()) {
                            this.note_working_set[this.note_order.pop()] = 0;
                        }
                        document.getElementById("correct").innerText = `"${value}" is correct!`;
                    } else {
                        const num_left = this.note_working_set[this.curr_random_note]
                        document.getElementById("correct").innerText = `"${value}" is correct! There are ${-num_left + 1} more until "${value}" is finished.`;
                    }
                    if (!this.random_next()) {
                        alert("Finished.");
                        window.location.reload();
                    };
                }
            }
        };

        // Wow, black keys are hard so just slice them out (for now).


        let controller = new Controller(notes);
        notes.forEach((note) => {
            const el = document.getElementById(note);
            el.onclick = () => {
                controller.submit(note);
            }
        });

        // Keyboard access to keys.
        document.onkeydown = (evt) => {
            const key = evt.key.toUpperCase();
            const found_key = document.getElementById(key);
            if (found_key) {
                found_key.click();
            }
        };


        // Init.
        window.onload = () => { controller.random_next(); }
        document.getElementById("btn_play_tone").onclick = () => {
            controller.play_current_note();
        };
    </script>
</body>

</html>