<!DOCTYPE HTML>
<html xml:lang="en" lang="en">

<head>
    <!-- Primary Meta Tags -->
    <meta charset="utf-8" />
    <title>Piano Keys Game</title>
    <meta name="title" content="Pickup line game">
    <meta name="description" content="A game where you do pickup lines">
</head>

<style>
    * {
        font-family: Helvetica, sans-serif;
    }

    input[type="button"] {
        font-size: 24px;
    }

    input[type=text] {
        width: 400px;
        font-size: 18pt;
        margin-bottom: 5px;
    }

    #div_container {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #div_main {
        width: min(100%, 500px);
    }

    #div_stimulus {
        min-height: 4em;
    }
</style>

<body>
    <div id="div_container">
        <div id="div_main">
            <canvas id="my_canvas" width="400px">
            </canvas>
            <br>
            <input type="text" name="response" id="response" name="response" width="400px"></input>
            <br>
            <input type="button" id="submit" value="Submit"></input>
            <input type="button" id="next" value="Next"></input>
            <input type="button" id="reveal" value="Reveal"></input>
            <p id="right_answer" style="color: Red;"></p>
        </div>
    </div>

    <script>
        const img_url = "piano_keys.png";
        const img_ratio = 0.6270833333333333;
        const canvas_width = 400;
        const canvas = document.getElementById("my_canvas");
        canvas.width = canvas_width;
        const context = canvas.getContext("2d");
        context.globalCompositeOperation = "source-over";
        canvas.height = canvas.width * img_ratio;
        const img = new Image();
        img.src = img_url;
        const notes = [
            "C", "D", "E", "F", "G", "A", "B",
            "C#/Db", "D#/Eb", "F#/Gb", "G#/Ab", "A#/Bb"
        ];
        function shuffleArray(array) {
            let curId = array.length;
            // There remain elements to shuffle
            while (0 !== curId) {
                // Pick a remaining element
                let randId = Math.floor(Math.random() * curId);
                curId -= 1;
                // Swap it with the current element.
                let tmp = array[curId];
                array[curId] = array[randId];
                array[randId] = tmp;
            }
            return array;
        }

        let note_order = shuffleArray(notes);
        let note_working_set = {}
        function has_more_notes() {
            return Object.keys(note_working_set).length < 4 && note_order.length > 0;
        }
        while (has_more_notes()) {
            note_working_set[note_order.pop()] = 0;
        }


        function update_note_score(note, true_if_right) {
            note_scores[note] += true_if_right ? 1 : -1;
        }
        //const note_scores = notes.map(value => ({value: 0}));
        //console.log(note_scores);
        const input_response = document.getElementById("response");
        const right_answer = document.getElementById("right_answer");
        function random_int(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }

        function draw_piano() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);
        }

        function drawNote(note_str) {
            right_answer.innerText = "";
            function draw_circle(x, y) {
                let radius = 10;
                context.beginPath();
                context.fillStyle = '#ff0000';
                context.strokeStyle = '#ff0000';
                context.lineWidth = 2;
                context.arc(x, y, radius, 0, 2 * Math.PI, false);
                context.fill();
                context.stroke();
            }
            draw_piano();
            // Assumes 400px width for piano canvas.
            const data = {
                "C": [30, 200],
                "D": [87, 200],
                "E": [144, 200],
                "F": [201, 200],
                "G": [258, 200],
                "A": [315, 200],
                "B": [372, 200],
                "C#/Db": [58, 100],
                "D#/Eb": [115, 100],
                "F#/Gb": [229, 100],
                "G#/Ab": [286, 100],
                "A#/Bb": [343, 100]
            }
            //const {x,y} = data[note_str];
            const [x, y] = data[note_str];
            draw_circle(x, y);
        }
        function reveal_answer() {
            right_answer.innerText = curr_random_note;
        }
        let curr_random_note = null;
        function random_next() {
            response.value = "";
            //const i = random_int(0, notes.length);
            const note_working_set_array = Object.keys(note_working_set);
            if (note_working_set_array.length == 0) {
                return false;  // No more items.
            }
            let note = null;
            while (true) {
                const i = random_int(0, note_working_set_array.length);
                note = note_working_set_array[i];
                if (note_working_set_array.length == 1 || note != curr_random_note) {
                    break;
                }
            }
            curr_random_note = note;
            console.log(note);
            drawNote(note);
            return true;  // More in the set.
        }
        // Init.
        window.onload = random_next;
        document.getElementById("next").onclick = random_next;
        document.getElementById("submit").onclick = () => {
            const value = input_response.value;
            input_response.value = "";
            if (value != curr_random_note) {
                // Two, because the next answer will be right.
                note_working_set[curr_random_note] -= 2;
                reveal_answer();
            } else {
                note_working_set[curr_random_note] += 1;
                if (note_working_set[curr_random_note] > 0) {
                    delete note_working_set[curr_random_note];
                    if (has_more_notes()) {
                       note_working_set[note_order.pop()] = 0;
                    }
                }
                if (!random_next()) {
                    alert("Finished.");
                    window.location.reload();
                };
            }
        };
        document.getElementById("reveal").onclick = () => {
            reveal_answer();
        };

        input_response.onkeydown = (event) => {
            if (event.key === 'Enter') {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                document.getElementById("submit").click();
                return;
            }
        }
    </script>
</body>

</html>